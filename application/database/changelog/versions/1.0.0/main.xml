<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

    <changeSet id="1.0.0" author="ddryuchin">
        <tagDatabase tag="1.0.0"/>
    </changeSet>

    <changeSet id="SCHREGISTER-17-1" author="ddryuchin" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ESU_INPUT"/>
            </not>
        </preConditions>
        <createTable tableName="ESU_INPUT" remarks="">
            <column name="ID" type="BIGINT" remarks="Идентификатор записи, формируется автоматически">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="TOPIC" type="VARCHAR(1000)" remarks="Наименование топика">
                <constraints nullable="false"/>
            </column>
            <column name="ES_ID" type="VARCHAR(1000)" remarks="Наименование топика">
                <constraints nullable="false" unique="true" uniqueConstraintName="esu_input_es_id_uniq"/>
            </column>
            <column name="ERROR" type="VARCHAR(4000)" remarks="Текст ошибки" />
            <column name="STATUS" type="SMALLINT" remarks="Статус обработки сообщения">
                <constraints nullable="false"/>
            </column>
            <column name="DATE_CREATED" type="TIMESTAMP(6)"  remarks="Дата/время создания записи">
                <constraints nullable="false"/>
            </column>
            <column name="DATE_UPDATED" type="TIMESTAMP(6)"  remarks="Дата/время обновления записи">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <rollback>
            <dropTable tableName="ESU_INPUT"/>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-17-2" author="ddryuchin" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="SEQ_ESU_INPUT_ID"/>
            </not>
        </preConditions>
        <comment>Создание сиквенса для таблицы ESU_INPUT</comment>
        <createSequence sequenceName="SEQ_ESU_INPUT_ID" />
        <rollback>
            <dropSequence sequenceName="SEQ_ESU_INPUT_ID"/>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-17-3" author="ddryuchin" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="PLANNERS_LOG"/>
            </not>
        </preConditions>
        <createTable tableName="PLANNERS_LOG" remarks="">
            <column name="ID" type="BIGINT" remarks="Идентификатор записи, формируется автоматически">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="PLANNER" type="VARCHAR(1000)" remarks="Название планировщика">
                <constraints nullable="false"/>
            </column>
            <column name="HOST" type="VARCHAR(1000)" remarks="Нода, на которой работал планировщик">
                <constraints nullable="false"/>
            </column>
            <column name="ERROR" type="VARCHAR(4000)" remarks="Ошибка, полученная при работе планировщика"/>
            <column name="DATE_START" type="TIMESTAMP(6)" remarks="Дата/время начала работы">
                <constraints nullable="false"/>
            </column>
            <column name="DATE_END" type="TIMESTAMP(6)" remarks="Дата/время окончания работы"/>
            <column name="DATE_MONITORING" type="TIMESTAMP(6)" remarks="Дата/время окончания работы"/>
        </createTable>
        <rollback>
            <dropTable tableName="PLANNERS_LOG"/>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-17-4" author="ddryuchin" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="SEQ_PLANNERS_LOG_ID"/>
            </not>
        </preConditions>
        <comment>Создание сиквенса для таблицы PLANNERS_LOG</comment>
        <createSequence sequenceName="SEQ_PLANNERS_LOG_ID"/>
        <rollback>
            <dropSequence sequenceName="SEQ_PLANNERS_LOG_ID"/>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-17-5" author="ddryuchin" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="CONFIG"/>
            </not>
        </preConditions>
        <createTable tableName="CONFIG" remarks="Системные параметры">
            <column name="code" type="VARCHAR(100)" remarks="Код настройки (имя системного параметра)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="val" type="VARCHAR(1000)" remarks="Значение настройки">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(1000)" remarks="Описание (бизнес название системного параметра)">
                <constraints nullable="false"/>
            </column>
            <column name="date_updated" type="TIMESTAMP(6)" remarks="Дата/время последнего изменения настройки">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <rollback>
            <dropTable tableName="CONFIG"/>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-19-1" author="sorlov" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'esu.readTimeout'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Таймаут чтения из ЕСУ, в мс</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="esu.readTimeout"/>
            <column name="DESCRIPTION" value="Таймаут чтения из ЕСУ, в мс"/>
            <column name="VAL" value="3000"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='esu.readTimeout'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-19-2" author="sorlov" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'esu.emptyQueueWaitTime'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Время ожидания при отсутствии сообщений в очереди, в мс</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="esu.emptyQueueWaitTime"/>
            <column name="DESCRIPTION" value="Время ожидания при отсутствии сообщений в очереди, в мс"/>
            <column name="VAL" value="5000"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='esu.emptyQueueWaitTime'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-19-3" author="sorlov" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'attachmentEventImportService.run.mode'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Режим работы слушателя топика AttachmentEvent</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="attachmentEventImportService.run.mode"/>
            <column name="DESCRIPTION" value="Режим работы слушателя топика AttachmentEvent. Возможные значения: 0 - выключен; 1 - включен"/>
            <column name="VAL" value="1"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='attachmentEventImportService.run.mode'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-20-1" author="sorlov" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'erpChangePatientPersonalDataImportService.run.mode'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Режим работы слушателя топика ErpChangePatientPersonalData</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="erpChangePatientPersonalDataImportService.run.mode"/>
            <column name="DESCRIPTION" value="Режим работы планировщика ErpChangePatientPersonalDataImportService. Возможные значения: 0 - выключен; 1 - включен"/>
            <column name="VAL" value="1"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='erpChangePatientPersonalDataImportService.run.mode'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-21-3" author="sevgeniy" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'erpChangePatientPoliciesImportService.run.mode'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Режим работы слушателя топика ErpChangePatientPoliciesImportService</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="erpChangePatientPoliciesImportService.run.mode"/>
            <column name="DESCRIPTION" value="Режим работы планировщика ErpChangePatientPoliciesImportService (false - выключен; true – включен)"/>
            <column name="VAL" value="1"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='erpChangePatientPoliciesImportService.run.mode'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-24-1" author="sorlov" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'schoolAttachmentEventImportService.run.mode'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Режим работы слушателя топика SchoolAttachmentEvent</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="schoolAttachmentEventImportService.run.mode"/>
            <column name="DESCRIPTION" value="Режим работы планировщика SchoolAttachmentEventImportService. Возможные значения: 0 - выключен; 1 - включен"/>
            <column name="VAL" value="1"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='schoolAttachmentEventImportService.run.mode'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-35-1" author="ddryuchin" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ES_JOURNAL_REQUESTS"/>
            </not>
        </preConditions>
        <createTable tableName="ES_JOURNAL_REQUESTS" remarks="Журнал с историей запросов к методам">
            <column name="ID" type="BIGINT" remarks="Идентификатор записи, формируется автоматически">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="METHOD_NAME" type="VARCHAR(1000)" remarks="Наименование метода">
                <constraints nullable="false"/>
            </column>
            <column name="URI" type="VARCHAR(1000)" remarks="Идентификатор ресурса, куда обращается клиент">
                <constraints nullable="false"/>
            </column>
            <column name="SYSTEM_NAME" type="VARCHAR(1000)" remarks="Шифр системы-потребителя">
                <constraints nullable="false"/>
            </column>
            <column name="USER_NAME" type="VARCHAR(1000)" remarks="Имя пользователя">
                <constraints nullable="false"/>
            </column>
            <column name="REQUEST" type="VARCHAR(4000)" remarks="Текст запроса к методу">
                <constraints nullable="false"/>
            </column>
            <column name="HTTP_STATUS_CODE" type="BIGINT" remarks="Код ответа метода">
                <constraints nullable="false"/>
            </column>
            <column name="ERROR_MESSAGE" type="VARCHAR(4000)" remarks="Текст ошибки метода"/>
            <column name="DATE_REQUEST" type="TIMESTAMP(6)"  remarks="Дата/время создания записи">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <rollback>
            <dropTable tableName="ES_JOURNAL_REQUESTS"/>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-35-2" author="ddryuchin" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="SEQ_ES_JR_ID"/>
            </not>
        </preConditions>
        <comment>Создание сиквенса для таблицы ES_JOURNAL_REQUESTS</comment>
        <createSequence sequenceName="SEQ_ES_JR_ID" />
        <rollback>
            <dropSequence sequenceName="SEQ_ES_JR_ID"/>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-27-1" author="sorlov" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'erpChangePatientPersonalDataHandlerService.run.mode'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Режим работы слушателя топика erpChangePatientPersonalDataHandlerService</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="erpChangePatientPersonalDataHandlerService.run.mode"/>
            <column name="DESCRIPTION" value="Режим работы планировщика erpChangePatientPersonalDataHandlerService (false - выключен; true – включен)"/>
            <column name="VAL" value="1"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='erpChangePatientPersonalDataHandlerService.run.mode'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-27-2" author="sorlov" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'erpChangePatientPersonalDataHandlerService.numberMsg'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Размер одной выборки для обработки из ЕСУ (для планировщика erpChangePatientPersonalDataHandlerService)</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="erpChangePatientPersonalDataHandlerService.numberMsg"/>
            <column name="DESCRIPTION" value="Размер одной выборки для обработки из ЕСУ (для планировщика erpChangePatientPersonalDataHandlerService)"/>
            <column name="VAL" value="100"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='erpChangePatientPersonalDataHandlerService.numberMsg'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-27-3" author="sorlov" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'erpChangePatientPersonalDataHandlerService.resetInterval'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Интервал времени, по истечении которого сообщение в статусе "в обработке" считается "зависшим", в часах (для планировщика erpChangePatientPersonalDataHandlerService)</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="erpChangePatientPersonalDataHandlerService.resetInterval"/>
            <column name="DESCRIPTION" value="Интервал времени, по истечении которого сообщение в статусе 'в обработке' считается 'зависшим', в часах (для планировщика erpChangePatientPersonalDataHandlerService)"/>
            <column name="VAL" value="24"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='erpChangePatientPersonalDataHandlerService.resetInterval'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="SCHREGISTER-27-4" author="sorlov" labels="1.0.0.0">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="CONFIG"/>
                <sqlCheck expectedResult="0">select count(*) from CONFIG where CODE = 'erpChangePatientPersonalDataHandlerService.emptyQueueWaitTime'</sqlCheck>
            </and>
        </preConditions>
        <comment>CONFIG - Время ожидания при отсутствии записей в таблице ESU_INPUT, в мс (для планировщика erpChangePatientPersonalDataHandlerService)</comment>
        <insert tableName="CONFIG">
            <column name="CODE" value="erpChangePatientPersonalDataHandlerService.emptyQueueWaitTime"/>
            <column name="DESCRIPTION" value="Время ожидания при отсутствии записей в таблице ESU_INPUT, в мс (для планировщика erpChangePatientPersonalDataHandlerService)"/>
            <column name="VAL" value="5000"/>
            <column name="DATE_UPDATED" valueDate="now()"/>
        </insert>
        <rollback>
            <delete tableName="CONFIG">
                <where>CODE='erpChangePatientPersonalDataHandlerService.emptyQueueWaitTime'</where>
            </delete>
        </rollback>
    </changeSet>

</databaseChangeLog>